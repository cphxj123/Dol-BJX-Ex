:: Widgets Wraith [widget]
<<widget "generateWraith">>
	<<if _args[0] is undefined>>
		<<set _w to 1>>
	<<else>>
		<<set _w to _args[0]>>
	<</if>>
	<<set _n to (_w -1)>>
	<<if $NPCName[$NPCNameList.indexOf("Ivory Wraith")].init isnot 1>>
		<<set _strapIgnore to true>><<set _condomIgnore to true>>
		<<generateNPC _w a n n 20>>
		<<set $NPCList[_n].skincolour to "ghost">>
		<<saveNPC _n "temp_wraith">>
		<<clearsinglenpc _n>>
		<<initnpc "Ivory Wraith">>
		<<run ["gender", "pregnancyAvoidance", "vagina", "penis", "chest", "skincolour", "breastsize", "breastsdesc", "breastdesc", "penisdesc", "penissize", "trust", "type"].forEach(s => C.npc["Ivory Wraith"][s] = clone($per_npc.temp_wraith[s]))>>
		<<npc "Ivory Wraith">>
		<<clearNPC "temp_wraith">>
	<<else>>
		<<npc "Ivory Wraith">>
	<</if>>
	<<checkWraith>>
	<<if _args[1]>>
		<<set $wraith.seen++>>
	<</if>>
	<<personselect _n>>
<</widget>>

<!-- Recursive. With no argument, picks one at random. If option is disabled, runs as another argument. Can not infinite loop. -->
<<widget "initWraith">>
	<<if _args[0]>>
		<<set $wraith.gen to _args.random()>>
		<<set $pronoun to "i">>
		<<statsWraith>>
		<<switch $wraith.gen>>
			<<case "man">>
				<<set $molestationstart to 1>>
				<<set $wraith.type to "man">>
				<<set _genderknownbeforehand to true>>
				<<set $noBodyWriting to true>>
				<<set $stealtarget to "012345">>
				<<maninit>>
				<<set $enemyhealthmax to _wraithHP>>
				<<set $enemyhealth to _wraithHP>>
				<<set $enemyarousalmax to 700>>
				<<set $enemyanger += ($NPCName[$NPCNameList.indexOf("Ivory Wraith")].lust * 5)>>
				<<set $enemytrust -= ($NPCName[$NPCNameList.indexOf("Ivory Wraith")].lust * 2)>>
				<<npcexpose>>
			<<case "slimetentacles">>
				<<if $debug is 1>>
					/* Unreachable until swarms are un-fucked */
					<<if $slimedisable is "f" and $tentacledisable is "f">>
						<<set $molestationstart to 1>>
						<<set $wraith.type to "tentacles">>
						<<swarminit "slimes" "slime mass" "moving towards you" "encircle you" "fend off" _wraithSlimes 0>>
						<<tentaclestart _wraithTentacles 18 "tentacle" "pale">>
					<<else>>
						<<initWraith "tentacles">>
					<</if>>
				<<else>>
					<<initWraith "tentacles">>
				<</if>>
			<<case "slime">>
				<<if $slimedisable is "f">>
					<<set $struggle_start to 1>>
					<<set $wraith.type to "slime">>
					<<struggle_init>>
					<<set $struggle.creature to "pale slime">>
					<<if $wraith.state is "haunt">>
						<<struggle_creatures 4 2>>
					<<else>>
						<<struggle_creatures 3 1>>
					<</if>>
				<<else>>
					<<initWraith "tentacles">>
				<</if>>
			<<case "tentacles">>
				<<if $tentacledisable is "f">>
					<<set $molestationstart to 1>>
					<<set $wraith.type to "tentacles">>
					<<tentaclestart _wraithTentacles 18 "tentacle" "pale">>
				<<else>>
					<<initWraith "arms">>
				<</if>>
			<<case "abomination">>
				<<if $tentacledisable is "f">>
					<<set $molestationstart to 1>>
					<<set $wraith.type to "man">>
					<<set $abomination to 1>>
					<<set _genderknownbeforehand to true>>
					<<set $noBodyWriting to true>>
					<<maninit>>
					<<npcexpose>>
					<<set $enemyhealthmax to _wraithHP>>
					<<set $enemyhealth to _wraithHP>>
					<<set $enemyarousalmax to 1300>>
					<<set $enemyanger += ($NPCName[$NPCNameList.indexOf("Ivory Wraith")].lust * 5)>>
					<<set $enemytrust -= ($NPCName[$NPCNameList.indexOf("Ivory Wraith")].lust * 2)>>
					<<tentaclestart _wraithTentaclesAbomination 15 "tentacle" "pale">>
					/* This felt a bit too powerful, partially disabled for now. */
					<<for _i to 0; _i lt $tentacles.active; _i++>>
						/*<<set $enemyhealthmax += $tentacles[_i].tentaclehealth>>*/
						/*<<set $enemyhealth += $tentacles[_i].tentaclehealth>>*/
						<<set $enemyarousalmax += $tentacles[_i].tentaclehealth>>
					<</for>>
				<<else>>
					<<initWraith "arms">>
				<</if>>
			<<case "arms">>
				<<set $molestationstart to 1>>
				<<set $breakIgnore to true>>
				<<set $wraith.type to "man">>
				<<set _genderknownbeforehand to true>>
				<<set $noBodyWriting to true>>
				<<set $stealtarget to "012345">>
				<<maninit>>
				<<for _iw to 1; _iw lt 4; _iw++>>
					<<npc "Ivory Wraith" -1>>
					<<set $NPCList[_iw].lefthand to 0>>
					<<set $NPCList[_iw].righthand to 0>>
					<<set $NPCList[_iw].mouth to "none">>
					<<set $NPCList[_iw].penis to "none">>
					<<set $NPCList[_iw].vagina to "none">>
					<<set $NPCList[_iw].active to "active">>
				<</for>>
				<<set $enemyhealth to _wraithHP>>
				<<set $enemyhealthmax to _wraithHP>>
				<<npcexpose>>
				<<set $enemyarousalmax to 700>>
				<<set $enemyanger += ($NPCName[$NPCNameList.indexOf("Ivory Wraith")].lust * 5)>>
				<<set $enemytrust -= ($NPCName[$NPCNameList.indexOf("Ivory Wraith")].lust * 2)>>
			<<default>>
				<<initWraith "man">>
		<</switch>>
		<<if $wraithHealth>>
			<<set $enemyhealth to $wraithHealth>>
		<</if>>
	<<else>>
		<<switch random(1, 6)>>
			<<case 1>>
				<<if $wraith.state is "haunt" or isBloodmoon()>>
					<<initWraith "abomination">>
				<<else>>
					<<initWraith "man">>
				<</if>>
			<<case 2>>
				<<initWraith "tentacles">>
			<<case 3>>
				<<initWraith "slimetentacles">>
			<<case 4>>
				<<initWraith "slime">>
			<<case 5>>
				<<initWraith "abomination">>
			<<case 6>>
				<<initWraith "arms">>
		<</switch>>
	<</if>>
	<<set $speechdisable to 1>><<set $enemynomax to 1>>
<</widget>>

<<widget "statsWraith">>
	<<set _wraithMod to (1 + (Math.floor($NPCName[$NPCNameList.indexOf("Ivory Wraith")].lust / 3)))>>
	<<set _wraithHP to 600 + (50 * _wraithMod)>>
	<<set _wraithSlimes to (1 + _wraithMod)>>
	<<set _wraithTentacles to Math.clamp((4 + _wraithMod), 6, 10)>>
	<<set _wraithTentaclesAbomination to Math.clamp(Math.floor(1 + _wraithMod), 4, 7)>>
<</widget>>

<<widget "startWraith">>
	<<switch $wraith.gen>>
		<<case "man">>
			<<He>> raises <<his>> hand, and you're forced to kneel.
		<<case "abomination">>
			Many tentacles burst from <<his>> back, and <<he>> pulls you in.
		<<case "arms">>
			Several extra pairs of arms emerge from <<his>> back.
		<<case "tentacles" "slimetentacles">>
			<<He>> raises <<his>> hands, and swirling purple discs appear all around you. Tendrils erupt from them, grabbing you. <<He>> sits back mid-air, and watches with a grin.
		<<case "slime">>
			<<He>> makes strange motions with <<his>> arms, and a swirling purple disc appears in the air. Several large pale slimes emerge from it. <<He>> sits back mid-air, and watches with a grin.
	<</switch>>
<</widget>>

<<widget "continueWraith">>
	<<if !$wraithOptions>>
		<<if $consensual is 1>>
			<<set $wraithOptions to ["man", "tentacles", "abomination", "arms"]>>
		<<else>>
			<<set $wraithOptions to ["man", "tentacles", "abomination", "slime", "arms"]>>
		<</if>>
	<</if>>
	<<set _wraithLast to $wraith.gen>>
	<<set _wraithSelect to $wraithOptions.pluck()>>
	<<set $wraithHealth to $enemyhealth>>
	<<endcombat>>
	<<generateWraith 1>>
	<<initWraith _wraithSelect>>
	<<set $NPCList[0].intro to 0>>
	<<set $enemyhealth to $wraithHealth>>
	<<if $pain gte 50 and $bus isnot "lake_ruin_prison">>
		<<kissWraith>>
	<</if>>
	<<if _wraithLast is $wraith.gen>>
		It looks down at you with a smile. "<span class="wraith">Again.</span>"
	<<else>>
		<<switch $wraith.gen>>
			<<case "man">>
				<<He>> raises <<his>> hand, and an invisible force pulls you back in. "<span class="wraith">Forever.</span>"
			<<case "abomination">>
				Many tentacles burst from <<his>> back, and <<he>> pulls you in. "<span class="wraith">Embrace it.</span>"
			<<case "arms">>
				Several extra pairs of arms emerge from <<his>> back. "<span class="wraith">You'll never be free again.</span>"
			<<case "tentacles" "slimetentacles">>
				<<He>> raises <<his>> hands, and swirling purple discs appear all around you. Tendrils erupt from them, grabbing you. <<He>> sits back mid-air, and watches with a grin. "<span class="wraith">The writhing ensues.</span>"
			<<case "slime">>
				<<He>> makes strange motions with <<his>> arms, and a swirling purple disc appears in the air. Several large pale slimes emerge from it. <<He>> sits back mid-air, and watches with a grin. "<span class="wraith">The waves chew.</span>"
		<</switch>>
	<</if>>
<</widget>>

<<widget "endWraith">>
	<<if $enemyhealth gt 0>>
		<<set $wraithHealth to $enemyhealth + 50>>
	<<else>>
		<<unset $wraithHealth>>
	<</if>>
	<<endevent>>
	<<run delete $wraith.type>>
	<<run delete $wraith.select>>
	<<run delete $wraith.gen>>
	<<unset $wraithOptions>>
	<<set $wraith.mimic to "">>
	<<unset $wraithCount>>
	<<unset $wraithMax>>
	<<set $wraith.revealed to false>>
	<<if $real_weather>>
		<<set $weather to $real_weather>>
		<<unset $real_weather>>
	<</if>>
	<<if $controlSaved>>
		<<set $control to $controlSaved>>
		<<unset $controlSaved>>
	<</if>>
	<<if $wraith.nightmare is 2>>
		<<set $wraith.nightmare to 0>>
	<</if>>
	<<if $possessed>>
		<<if $wraith.possessCount is undefined>>
			<<set $wraith.possessCount to 1>>
		<<else>>
			<<set $wraith.possessCount++>>
		<</if>>
		<<unset $possessed>><<canvas-model-override "clear">>
	<</if>>
	<<unset $nextPassage>>
	<<unset $nextPassageIntended>>
	<<unset $nextPassageCheck>>
	<<unset $phaseWraith>>
	<<unset $wraithBedSpeech>>
<</widget>>

<<widget "rainWraith">>
	<<if $weather isnot "rain" and $weather isnot "snow">>
		<<set $real_weather to $weather>>
		<<if Time.season is "winter">>
			<<set $weather to "snow">>
		<<else>>
			<<set $weather to "rain">>
		<</if>>

		<<if _args[0]>>
			<<if $outside is 1>>
				<<if $weather is "snow">>
					<<print either(
						"You don't remember when it started snowing. It's already hard to see.",
						"The wind picks up, and visibility drops as a snow squall rolls in.",
						"You feel snowflakes on your skin."
					)>>
				<<else>>
					<<print either(
						"You don't remember when it started raining.",
						"The wind picks up, and it starts to rain.",
						"You feel raindrops on your skin."
					)>>
				<</if>>
			<<else>>
				<<print either(
					"You don't remember when the fog rolled in. It's already hard to see.",
					"An inexplicable wind picks up, and a fog rolls in.",
					"Fog envelops your surroundings."
				)>>
			<</if>>
		<</if>>
	<</if>>
<</widget>>

<<widget "endRainWraith">>
	<<if $real_weather>>
		<<if _args[0]>>
			<<if $outside is 1>>
				<<if $weather is "rain">>
					<<print either(
						"The sky begins to clear up.",
						"The rain suddenly stops.",
						"The rain relents."
					)>>
				<<else>>
					<<print either(
						"The sky begins to clear up.",
						"The snow suddenly stops.",
						"The snow relents."
					)>>
				<</if>>
			<<else>>
				<<print either(
					"The surroundings begins to clear up.",
					"The fog suddenly dissipates.",
					"The fog relents."
				)>>
			<</if>>
		<</if>>
		<<set $weather to $real_weather>>
		<<unset $real_weather>>
	<</if>>
<</widget>>

<<widget "checkWraith">>
	<<if !$wraith.init>>
		<<set $wraith to {init: 1, seen: 0, days: 0, defeated: 0, evaded: 0, nightmare: 0, timer: 0, hunt: 0, state: "", mimic: "", revealed: false, offspring: "", exit: ""}>>
	<</if>>
	<<if Time.days gte 32 and Time.monthName isnot "October" and !$wraithSkip>>
		<<if $museumAntiques.antiques.antiqueivorynecklace isnot "notFound">>
			<<if $necklaceThief is "player">>
				<<set $wraith.state to "haunt">>
			<<else>>
				<<set $wraith.state to "despair">>
			<</if>>
		<<else>>
			<<set $wraith.state to "active">>
		<</if>>
	<</if>>
	<<if _args[0]>>
		<<if $wraith.state isnot "" and !$wraithCheck and $wraith.nightmare is 0 and (random(0,2) is 2 or $wraith.state is "haunt" or $wraith.offspring is "dead")>>
			<<set $wraith.nightmare to 1>>
			<<set $wraithCheck to true>>
		<</if>>
		<<if $moonstate isnot "morning" and $wraith.state isnot "" and $wraith.timer lte 0>>
			<<set $wraith.timer to C.npc["Ivory Wraith"].lust>>
		<</if>>
	<</if>>
<</widget>>

<<widget "clearWraith">>
	<<if $wraith>>
		<<if $foresthunt gte 1 and $blackwolfhunt is 0 and $edenforesthunt is 0>>
			<<set $foresthunt to 0>>
		<</if>>
		<<set $wraith.mimic to "">>
		<<set $wraith.exit to "">>
		<<set $wraith.nightmare to 0>>
		<<set $wraith.hunt to 0>>
		<<set $wraith.timer to 0>>
		<<set $wraith.evaded to 0>>
		<<unset $wraithCheck>>
		<<unset $wPersist>>
		<<unset $wraithSkip>>
		<<run delete $wraith.type>>
		<<run delete $wraith.select>>
		<<run delete $wraith.gen>>
		<<run delete $wraith.will>>
		<<unset $wraithOptions>>
		<<unset $wraithCount>>
		<<unset $wraithMax>>
		<<unset $wraithHealth>>
		<<if $possessed>>
			<<if $wraith.possessCount is undefined>>
				<<set $wraith.possessCount to 1>>
			<<else>>
				<<set $wraith.possessCount++>>
			<</if>>
			<<unset $possessed>><<canvas-model-override "clear">>
		<</if>>
		<<set $wraith.revealed to false>>
		<<if $real_weather>>
			<<set $weather to $real_weather>>
			<<unset $real_weather>>
		<</if>>
		<<unset $wraithWillMessage>>
		<<unset $nextPassage>>
		<<unset $nextPassageIntended>>
		<<unset $nextPassageCheck>>
		<<unset $phaseWraith>>
		<<unset $wraithPaleVisit>>
		<<unset $wraithApologise>>
		<<unset $wraithApologiseCooldown>>
	<</if>>
<</widget>>

<<widget "wraithEyes">><<silently>>
	<<set _text_output to (["haunt", "despair"].includes($wraith.state) ? "red" : "blue")>>
<</silently>><<print _text_output>><</widget>>

<<widget "wraithShamble">><<silently>>
	<<if $compoundWraith>>
		<<set _text_output to ($compoundWraith is "willing" ? "walk" : "shamble")>>
	<<else>>
		<<set _text_output to "shamble">>
	<</if>>
<</silently>><<print _text_output>><</widget>>

<<widget "speechWraith">><<silently>>
	<<if $possessed and _args[0] isnot "lines">>
		<<set $_npcWraith to _args[0] || "none">>
		<<set _speakPool to ["speak","grunt","giggle","whisper","sneer","laugh","yell","spit","speak in an eerily calm tone"]>>
		<<if $wolfgirl gte 4>>
			<<run _speakPool.pushUnique(
				"bark","growl","howl"
			)>>
		<</if>>
		<<if $cat gte 4>>
			<<run _speakPool.pushUnique(
				"meow","purr","hiss"
			)>>
		<</if>>
		<<if $cow gte 4>>
			<<run _speakPool.pushUnique(
				"moo","snort","huff"
			)>>
		<</if>>
		<<if $harpy gte 4>>
			<<run _speakPool.pushUnique(
				"chirp","screech","sing"
			)>>
		<</if>>
		<<if $fox gte 4>>
			<<run _speakPool.pushUnique(
				"bark","yipp","scream"
			)>>
		<</if>>
		/* 北极星模组 */
		<<if $dragon gte 4>>
			<<run _speakPool.pushUnique(
				"吼叫","呻吟","咆哮"
			)>>
		<</if>>
		/* 北极星 */

		<<set _linePool to ($_npcWraith is "none" ? [
			"Me.",
			"Stay.",
			"Give in.",
			"Not yet.",
			"Abandoned.",
			"Pretender.",
			"Take a bow.",
			"And so do we.",
			"Know your place.",
			"Maelstrom, tirade.",
			"A corpse can't speak.",
			"Why don't we find out?",
			"Just a little further.",
			"The strings comfort me.",
			"Our heaven, made of twigs.",
			"Never to see the moon again.",
			"Step aside, or be cast aside.",
			"A corpse should stay in its coffin.",
			"Don't repeat yourself. Don't bother.",
			"We were never here. That's why we left.",
			"Like sand slipping through our fingers.",
			"Even if I have to drag you there myself.",
			"Run. Forget that you have nowhere to go. Run.",
			"Come to my parlour, said the fly to the spider.",
			"What is within always conquers what is without.",
			"Steel yourself all you like. You'll eventually rust.",
			"History swallows the victims and spits out their bones.",
			"Desolate. Disappear. Drown. We'll come back to find you.",
			"It would be maddening, to only know the other end of the ordeal.",
			"Carve. Into. You. Our. Name. Perfection. Wash. Away. All. You. Are."
		] : [])>>
		<<if $npc.includes("Sydney")>>
			<<run statusCheck("Sydney")>>
			<<run _linePool.pushUnique(
				"Liar.",
				"Again.",
				"Sydney?",
				"Alone at last.",
				"I've lost ourself.",
				"Let us sleep forever.",
				"Can the innocent repent?",
				"You know why we're here.",
				"I'm sorry you put your trust in me.",
				"It's hilarious. Why aren't you laughing?",
				"It's okay now, Sydney. I'm back to normal.",
				"Block me out all you like. I am still here.",
				"Do you remember your <<sydneyOtherParent>>?",
				"They never stopped, because they never began.",
				"The light will consume you, slowly, painfully.",
				"We're glad to see you again. We missed you, you know.",
				"Do you remember? Of course you do. Of course you don't.",
				"What a terrible song, and you're not the one playing it.",
				"<<nnpc_He \"Harper\">> was so sure of <<nnpc_himself \"Harper\">>.",
				"The pure and the corrupt are at ends, but the end itself remains the same.",
				"As Two will emerge from One will emerge from Two <span class=\"tentacle\">As One</span>."
			)>>
			<<if $templePromised is "Sydney">>
				<<run _linePool.pushUnique("Calamity rings.")>>
			<</if>>
			<<if _sydneyStatus.includes("pure")>>
				<<run _linePool.pushUnique(
					"You'll understand once you fly.",
					"Baptisms with water of the womb.",
					"Every life has sin. Every sin has life."
				)>>
			<<elseif _sydneyStatus.includes("neutral")>>
				<<run _linePool.pushUnique(
					"Tipped with a void.",
					"And so long as that's true, it will never go away.",
					"Balance. Indecisiveness. Fear. There's a lot of words."
				)>>
			<<elseif _sydneyStatus.includes("corrupt")>>
				<<run _linePool.pushUnique(
					"No one will answer.",
					"What you fear, you have become.",
					"Was it worth it? Of course it was."
				)>>
			<</if>>
		<<else>>
			<<run _linePool.pushUnique(
				"You'll never be a part. We'll never be apart.",
				"We stand <span class=\"tentacle\">As One</span>, and you'll never be a part."
				)>>
		<</if>>
		<<if $npc.includes("Robin") or $_npcWraith is "Robin">>
			<<run _linePool.pushUnique(
				"Little nothing.",
				"The wing-clipped are better smothered.",
				"How far would you go? How far can you run?",
				"You've built your cage, songbird. Lie in it."
			)>>
			<<if $NPCName[$NPCNameList.indexOf("Robin")].trauma gte 20>>
				<<run _linePool.pushUnique("I'm sorry that you put your trust in <<phim>>.")>>
			<</if>>
			<<if $NPCName[$NPCNameList.indexOf("Robin")].cdquest gte 7>>
				<<run _linePool.pushUnique("New skin. Same sin.")>>
			<</if>>
		<</if>>
		<<if $npc.includes("Whitney") or $_npcWraith is "Whitney">>
			<<run _linePool.pushUnique(
				"Tormentor.",
				"Drown in smoke. Drown in flame.",
				"A suit of armor made of bodies. They're not here now."
			)>>
			<<if $whitneyrescued>>
				<<run _linePool.pushUnique("Betrayed by your worst enemy. Do you love <<phim>>?")>>
			<</if>>
		<</if>>
		<<if $npc.includes("Kylar") or $_npcWraith is "Kylar">>
			<<run _linePool.pushUnique(
				"Child of monsters.",
				"You've seen it, too.",
				"A shadow, just as faithless.",
				"Were your grip a little stronger.",
				"Blistering emerald green, blinding the world. Such is your envy."
			)>>
			<<if ["dead","sold"].includes($wraith.offspring)>>
				<<run _linePool.pushUnique("You failed them. You failed us.")>>
			<</if>>
			<<if $syndromekylar is 1>>
				<<run _linePool.pushUnique("Longing, belonging.")>>
			<</if>>
		<</if>>
		<<if $npc.includes("Eden") or $_npcWraith is "Eden">>
			<<run _linePool.pushUnique(
				"Eden...",
				"So much left unsaid.",
				"If you could take me with you...",
				"You never should have stopped running.",
				"Like a long lost friend you never knew.",
				"You'll never be far enough. It never leaves."
			)>>
			<<if $syndromeeden is 1>>
				<<run _linePool.pushUnique("You found a home, in collar and chains.")>>
			<</if>>
		<</if>>
		<<if $npc.includes("Avery") or $_npcWraith is "Avery">>
			<<run _linePool.pushUnique(
				"Not all stains wash out.",
				"Money. Material. Meaningless noise.",
				"You still wouldn't be able to afford it."
			)>>
			<<if $averyragerevealed is 1>>
				<<run _linePool.pushUnique("Wine mixes with blood, shed from the glass shattered.")>>
			<</if>>
		<</if>>
		<<if $npc.includes("Alex") or $_npcWraith is "Alex">>
			<<run _linePool.pushUnique(
				"You would be nothing.",
				"One of thirteen. Indistinguishable.",
				"Water down your mind, until you destroy all you love."
			)>>
			<<if $farm.aggro gte 60>>
				<<run _linePool.pushUnique("The locusts will have a new feast.")>>
			<</if>>
		<</if>>
		<<if $npc.includes("Black Wolf") or $_npcWraith is "Black Wolf">>
			<<run _linePool.pushUnique(
				"Wait your turn.",
				"The howl, too, drips with red.",
				"Dare to hunt. Be made to heel."
			)>>
			<<if $wolfpackleader is 1>>
				<<run _linePool.pushUnique("Bite the hand that feeds.")>>
			<</if>>
		<</if>>
		<<if $npc.includes("Great Hawk") or $_npcWraith is "Great Hawk">>
			<<run _linePool.pushUnique(
				"Wise to fear your reflection.",
				"An untended egg never hatches.",
				"Fly to the sun or sink in the mud.",
				"The song never stopped. Did it ever begin?"
			)>>
			<<if $birdFly is 1>>
				<<run _linePool.pushUnique("Count the feathers. Uncountable feathers.")>>
			<</if>>
		<</if>>

		<!-- Ideally, this part would be a for loop. I can't figure out how to generate a new temporary variable for each loop iteration,
		and if I use the same temp variable for each loop, only the last named NPC's name and title will be added to the pool.
		Temp arrays don't work either. -->
		<<if $npc[0]>>
			<<set _npc0 to clone($npc[0])>>
			<<set _title0 to $NPCName[$NPCNameList.indexOf($npc[0])].title.split(" ").pop()>>
			<<run _linePool.pushUnique(
				"_npc0 _npc0 _npc0 _npc0 _npc0 _npc0 _npc0 _npc0.",
				"Hie away, _title0 mine, hie away."
			)>>
		<</if>>
		<<if $npc[1]>>
			<<set _npc1 to clone($npc[1])>>
			<<set _title1 to $NPCName[$NPCNameList.indexOf($npc[1])].title.split(" ").pop()>>
			<<run _linePool.pushUnique(
				"_npc1 _npc1 _npc1 _npc1 _npc1 _npc1 _npc1 _npc1.",
				"Hie away, _title1 mine, hie away."
			)>>
		<</if>>
		<<if $npc[2]>>
			<<set _npc2 to clone($npc[2])>>
			<<set _title2 to $NPCName[$NPCNameList.indexOf($npc[2])].title.split(" ").pop()>>
			<<run _linePool.pushUnique(
				"_npc2 _npc2 _npc2 _npc2 _npc2 _npc2 _npc2 _npc2.",
				"Hie away, _title2 mine, hie away."
			)>>
		<</if>>
		<<if $npc[3]>>
			<<set _npc3 to clone($npc[3])>>
			<<set _title3 to $NPCName[$NPCNameList.indexOf($npc[3])].title.split(" ").pop()>>
			<<run _linePool.pushUnique(
				"_npc3 _npc3 _npc3 _npc3 _npc3 _npc3 _npc3 _npc3.",
				"Hie away, _title3 mine, hie away."
			)>>
		<</if>>
		<<if $npc[4]>>
			<<set _npc4 to clone($npc[4])>>
			<<set _title4 to $NPCName[$NPCNameList.indexOf($npc[4])].title.split(" ").pop()>>
			<<run _linePool.pushUnique(
				"_npc4 _npc4 _npc4 _npc4 _npc4 _npc4 _npc4 _npc4.",
				"Hie away, _title4 mine, hie away."
			)>>
		<</if>>
		<<if $npc[5]>>
			<<set _npc5 to clone($npc[5])>>
			<<set _title5 to $NPCName[$NPCNameList.indexOf($npc[5])].title.split(" ").pop()>>
			<<run _linePool.pushUnique(
				"_npc5 _npc5 _npc5 _npc5 _npc5 _npc5 _npc5 _npc5.",
				"Hie away, _title5 mine, hie away."
			)>>
		<</if>>

		<<set _speak to _speakPool.pluck()>>
		<<set _line1 to "<span class=\"wraith\">" + _linePool.pluck() + "</span>">>
		<<set _line2 to "<span class=\"wraith\">" + _linePool.pluck() + "</span>">>
		<<if random(0,2)>>
			<<set _speechWraith to "You _speak. \"_line1 _line2\"">>
		<<else>>
			<<set _speechWraith to "You _speak. \"_line1\"">>
		<</if>>
	<<elseif $wraith.state is "" and _args[0] isnot "lines">>
		<<set _speechWraith to ["The <<person>> holds <<his>> necklace tightly.", "The <<person>> whispers incoherently.","The <<person>> giggles quietly.","The <<person>> speaks in a language you don't understand.","The <<person>> opens <<his>> mouth, and your ears begin ringing.","The <<person>> says something, but you immediately forget what it was.","The <<person>> doesn't speak."].pluck()>>
	<<elseif $wraith.mimic isnot "" and $wraith.revealed is false and _args[0] isnot "lines">>
		<<switch $wraith.mimic>>
			<<case "Sydney">>
				<<set _speechWraith to either(
					"<<He>> speaks. \"Th-the temple will punish me for this... but I don't care anymore!\"",
					"<<He>> speaks. \"This is worth any punishment the temple will do to me.\"",
					"<<He>> speaks. \"We're both sinners now, aren't we?\"",
					"<<He>> speaks. \"This... still feels so wrong... but...\"",
					"<<He>> speaks. \"I love the feeling of you inside me.\"",
					"<<He>> speaks. \"We're still pure, right? This doesn't count?\"",
					"<<He>> speaks. \"Are you sure this feels good for you?\"",
					"<<He>> speaks. \"You look so cute down there.\"",
					"<<He>> barely manages to speak. \"If... if you... I'm going to...\"",
					"<<He>> speaks. \"I love being this close together.\"",
					"<<He>> speaks. \"I'm getting used to this feeling.\"",
					"<<He>> giggles. \"G... go ahead. Just be gentle, please.\"",
					"<<He>> moans. \"Do it! Deflower me! Make me yours!\"",
					"<<He>> giggles nervously. \"This is dangerous...\"",
					"<<He>> smiles gleefully. \"We both have to stay pure, after all!\"",
					"<<He>> laughs. \"I love it when you're rough!\"",
					"<<He>> lets out a clearly fake yawn. \"Already bored of the foreplay.\"",
					"<<He>> giggles. \"I wouldn't want anyone else to touch me like this.\"",
					"<<He>> speaks. \"Just relax, and let me take care of this.\"",
					"<<He>> giggles. \"I didn't know this spot could make someone feel good!\"",
					"<<He>> speaks. \"You're staring. At least let me look at yours, too...\"",
					"<<He>> speaks. \"I was always taught that this was sinful, but...\"",
					"<<He>> takes a deep breath. \"We... need to stay quiet...\"",
					"<<He>> giggles. \"I've sinned... is this my punishment?\"",
					"<<He>> giggles. \"W... we're doing this in the temple, and nothing is stopping us...\"",
					"<<He>> freezes. \"Wh... who? Who is it?!\""
				)>>
			<<default>>
		<</switch>>
	<<elseif $wraith.state is "active" and $rng lte 8 and _args[0] isnot "lines">>
		<<set _speechWraith to "<<He>> holds <<his>> necklace close.">>
	<<else>>
		<<if _args[0] isnot "lines">>
			<<set _speaks to [
				"<<He>> snarls",
				"<<He>> growls",
				"<<He>> cackles",
				"<<He>> purrs",
				"<<He>> hisses",
				"<<He>> emanates",
				"<<He>> speaks",
				"<<He>> grunts",
				"<<He>> giggles",
				"<<He>> whispers",
				"<<He>> speaks in an eerily calm tone",
				"<<His>> voice comes from directly behind you"
			].pluck()>>
		<</if>>
		<<if $alarm is 1>>
			<<set $alarm to 0>>
			<<set _speaks to "repeats your screams for help in a mocking tone, in your own voice">>
		<</if>>

		<<set _linePool to [
			"You.",
			"Give in.",
			"Take a bow.",
			"All for this.",
			"And so do you.",
			"The pursuit bends.",
			"Tick-tock, tick-tock.",
			"Endless, in the skies.",
			"Just a little further.",
			"I know why you're here.",
			"Relentless, in disguise.",
			"Is this your idea of heaven?",
			"Don't make me repeat myself.",
			"I can feel your heart pounding.",
			"With a dream that casts a shadow.",
			"But we both knew that, didn't we?",
			"Join me, why don't you? It's not far.",
			"Like sand slipping through your fingers.",
			"All that matters is the blissful present.",
			"One million, two million, three million, four.",
			"What is within is greater than what is without.",
			"I'm glad to see you again. I missed you, you know.",
			"Why did they leave? Because they were never there.",
			"We're all that's left. Can you hear them? No, you can't.",
			"It would be maddening, to only know one end of the ordeal.",
			"Here we stand, As Two, <span class=\"tentacle\">As One</span>.",
			"The pure die young, and the corrupt are as lambs to the slaughter.",
			"At the bottom, you'll find only darkness, and the darkness will be your everything.",
			"<<pcPetname \"Wraith\">>.","<<pcPetname \"Wraith\">>.","<<pcPetname \"Wraith\">>.",
			"<<pcPetname \"Wraith\">>, <<pcpetname \"Wraith\">>.", "<<pcPetname \"Wraith\">>, <<pcpetname \"Wraith\">>."
		]>>
		<<if $wraith.state is "haunt">>
			<<run _linePool.pushUnique(
				"Thief.",
				"Vulture.",
				"Graverobber.",
				"Give it back.",
				"Sleep forever.",
				"Cut you to perfection.",
				"Wrath wrath ?sin ?sin ?sin ?sin ?sin wrath.",
				"Water down your shame, until the lake runs dry.",
				"Shoot for the stars, that you may crash and burn.",
				"Until naught remains, but carved bone and midnight blue."
			)>>
		<<else>>
			<<run _linePool.pushUnique(
				"Just once, can't they stay?",
				"You did it. I knew you could do it.",
				"Lust lust ?sin ?sin ?sin ?sin ?sin lust.",
				"I'm sorry that you put your trust in me.",
				"Can I pretend you're back, if only for a while?"
			)>>
		<</if>>
		<<if $wraith.state is "despair">>
			<<run _linePool.pushUnique(
				"Where is it?",
				"You're so warm.",
				"Don't leave me.",
				"I can't find it.",
				"So cold.", "So cold.",
				"Can the innocent repent?",
				"Where did you go? Come back.",
				"Never to see the moon again.",
				"I see you. I see you. I see through you.",
				"Through my closed eyelids, you still glare.",
				"Have you seen my necklace?", "Have you seen my necklace?"
			)>>			
		<</if>>
		<<if C.npc["Ivory Wraith"].lust gte 10>>
			<<run _linePool.pushUnique(
				"Safety. Love. What beautiful lies.",
				"Carve your name. I'll wash it away.",
				"Even if I have to drag you there myself.",
				"You don't have enough. You never had enough.",
				"Let's see how you like being the puppet, hmm?",
				"Why don't you take off that pesky skin of yours?"
			)>>
		<</if>>
		<<if $templePromised is "Sydney">>
			<<run _linePool.pushUnique(
				"And you are wedded to calamity."
			)>>
		<</if>>
		<<if playerIsPregnant()>>
			<<run _linePool.pushUnique(
				"Cruel baptism.",
				"Twin heartbeats, led astray."
			)>>
		<</if>>
		<<if $wraithPrison and $wraithPrison.vision is true>>
			<<run _linePool.pushUnique(
				"Different place, same disgrace.",
				"It's comforting to know we have that in common.",
				"Stepped from the past. Steeped in the present. Yet to be stopped."
			)>>
		<</if>>
		<<if $wraith.offspring is "dead">>
			<<run _linePool.pushUnique(
				"Join them.",
				"Cast away forever.",
				"They cried for you, in their last moments."
			)>>
			<<if $wraith.state is "haunt">>
				<<run _linePool.pushUnique("Have you not stolen enough from me?")>>
			<</if>>
		<</if>>
		<<if $wraith.mimic isnot "">>
			<<run _linePool.pushUnique(
				"Pretender.",
				"$wraith.mimic $wraith.mimic $wraith.mimic $wraith.mimic $wraith.mimic $wraith.mimic $wraith.mimic $wraith.mimic."
			)>>
		<<else>>
			<<run _linePool.pushUnique("No one else. Alone. Desolate. Disappear. Drown.")>>
		<</if>>
		<<if $wraith.mimic is "Sydney" or ($wraith.mimic is "" and isLoveInterest("Sydney"))>>
			<<run _linePool.pushUnique(
				"I was <<nnpc_his \"Sydney\">> only friend, in that dark place beyond the trees.",
				"You think you can trust <<nnpc_him \"Sydney\">>. That's hilarious, but no one's laughing.",
				"Close your eyes and sleep, and only then will you truly see. I learned that from <<nnpc_him \"Sydney\">>."
			)>>
		<</if>>
		<<if $museumAntiques.antiques.antiquebell isnot "notFound">>
			<<run _linePool.pushUnique("The cold iron bell rings again.")>>
		<</if>>
		<<if $town_projects and $town_projects.road gte 3>>
			<<run _linePool.pushUnique(
				"Let the roads remain buried.",
				"Trespassers. Trespassers. It was you, wasn't it?",
				"Choking, cracking... smoking, smacking... will the noise ever stop?"
			)>>
		<</if>>
		<<if $hookah_state gte 2>>
			<<run _linePool.pushUnique(
				"All for this?",
				"It's happening again. It's happened again."
			)>>
		<</if>>
		<<if $awareness gte 400>>
			<<run _linePool.pushUnique(
				"The Elk fancies itself the predator.",
				"To be blind again. You'll miss your ignorance.",
				"The arrow of time struck midnight long before you were born."
			)>>
		<</if>>
		<<if $awareness gte 600>>
			<<run _linePool.pushUnique(
				"The shattered lie under the edge of blue.",
				"The chained are bound, by countless chains. The chains are bound to countless chained.",
				"Under bloody moon, under faithless sun. Dancing to my tune, standing here <span class=\"tentacle\">As One</span>."
			)>>
		<</if>>
		<<if $awareness gte 900>>
			<<run _linePool.pushUnique(
				"As Two, As One, yet the Third remains unfound.",
				"Reach out, with your six dreams.",
				"Blaze a trail across the sky.",
				"All things happen in threes.",
				"Until the Sands run dry.",
			)>>
		<</if>>
		<<if $angel gte 6>>
			<<run _linePool.pushUnique(
				"It won't last. It never does.",
				"Your descent will be beautiful.",
				"Fly with me, gaoler. Fly and fall.",
				"You were only a prisoner, after everything."
			)>>
		<<elseif $fallenangel gte 2>>
			<<run _linePool.pushUnique(
				"Falling. Falling. Falling.",
				"Almost like looking in a mirror.",
				"Was it worth it? Don't answer, you would be wrong.",
				"Open your eyes, blacken your wings, harden your heart."
			)>>
		<<elseif $demon gte 6>>
			<<run _linePool.pushUnique(
				"Sapphire and brimstone.",
				"All the world's to defile.",
				"You wear a mask. Your face molds to fit it.",
				"You think you've found the bottom. You've barely breached the surface."
			)>>
			<<if $spear_vessel is "held">>
				<<run _linePool.pushUnique("You've cut off your horns to spite your face.")>>
			<<elseif $spear_vessel is "Zephyr">>
				<<run _linePool.pushUnique("The horns split and grow. One million, two million...")>>
			<</if>>
		<</if>>
		<<if $spear_vessel>>
			<<if $spear_vessel is "held">>
				<<run _linePool.pushUnique(
					"A maze, ablaze.",
					"Too bright. Too warm."
				)>>
			<<elseif $spear_vessel is "sea">>
				<<run _linePool.pushUnique(
					"Ivory thinner than water. Irony thicker than blood.",
					"Like sand counting down eternity. The blade crumbles."
				)>>
			<<elseif $spear_vessel is "Zephyr">>
				<<run _linePool.pushUnique(
					"The light dims. The torch fades.",
					"You handed away salvation. Get it back.",
				)>>
			<</if>>
		<</if>>

		<<set _line1 to "<span class=\"wraith\">" + _linePool.pluck() + "</span>">>
		<<set _line2 to "<span class=\"wraith\">" + _linePool.pluck() + "</span>">>
		<<if random(0,2)>>
			<<set _speechWraith to "_speaks. \"_line1 _line2\"">>
		<<else>>
			<<set _speechWraith to "_speaks. \"_line1\"">>
		<</if>>
	<</if>>
<</silently>><<print _speechWraith>><</widget>>

<<widget "effectsWraith">>
	<<switch $wraith.gen>>
		<<case "man">>
			<<effectsman>>
			<<if $wraithApologise>>
				<<apologyWraith>>
			<<else>>
				<<man>>
			<</if>>
			<<rescueWraith>>
			<<stateman>>
			<br><br>
			<<actionsman>>
		<<case "arms">>
			<<set $enemynomax to 4>>
			<<effectsman>>
			<<for _iw to 1; _iw lt 4; _iw++>>
				<<set $NPCList[_iw].intro to -1>>
			<</for>>
			<<if $wraithApologise>>
				<<apologyWraith>>
			<<else>>
				<<man>>
			<</if>>
			<<rescueWraith>>
			<<set $enemyno to 1>>
			<<stateman>>
			<br><br>
			<<actionsman>>
		<<case "tentacles">>
			<<chastityBreakWraith>>
			<<set $NPCList[0].intro to 1>>
			<<effectstentacles>><<speechWraith>><<tentacles>>
			<<statetentacles>>
			<br><br>
			<<actionstentacles>>
		<<case "slimetentacles">>
			<<chastityBreakWraith>>
			<<set $NPCList[0].intro to 1>>
			<<swarmeffects>><<effectstentacles>><<speechWraith>>
			<<swarm>><<tentacles>>
			<<statetentacles>>
			<br><br>
			<<actionsOmni>>
		<<case "slime">>
			<<set $NPCList[0].intro to 1>>
			<<speechWraith>><<struggle>>
		<<case "abomination">>
			<<chastityBreakWraith>>
			<<effectsabomination>>
			<<if $wraithApologise>>
				<<apologyWraith>>
			<<else>>
				<<abomination>>
			<</if>>
			<<rescueWraith>>
			<<stateabomination>>
			<br><br>
			<<actionsabomination>>
	<</switch>>
<</widget>>

<<widget "chastityBreakWraith">>
	<<if $worn.genitals.name is "chastity parasite">> /* Do Nothing */
	<<elseif $possessed>>
		<<if $worn.under_lower.vagina_exposed is 1 and $worn.lower.vagina_exposed is 1 and playerChastity()>>
			Several tentacles worm their way around your legs.
			They slither into your $worn.genitals.name, and your own hand seems to guide them. It closes your fist, and the tentacles pull with an impossible force,
			<<if $worn.genitals.name.includes("gold")>>
				causing you immense pain as they struggle against the shining metal. You hear sizzling, and it seems to be harming the tentacles. <<gpain>><<pain 6>>
				<br><br>
				With one final pull, the metal fractures and splinters, sending shards of gold clattering to the ground as your $worn.genitals.name yields and shatters in a bright flash of light. Both the figure and the tentacles seem to be considerably weaker after the effort.
				<<if !$wraith.will>>
					<<set $wraith.will to random(1300,1700)>>
				<</if>>
				<<set $wraith.will -= 100>>
			<<else>>
				ripping your $worn.genitals.name to shreds.
			<</if>>
			<<set $worn.genitals.type.push("broken")>>
			<<genitalsruined>>
			<<if $vaginalchastityparasite isnot 0 or $analchastityparasite isnot 0 or $penilechastityparasite isnot 0>>
				<<set $vaginalchastityparasite to 0>><<set $analchastityparasite to 0>><<set $penilechastityparasite to 0>>
				<span class="lblue">The parasites within writhe their way out of your body,
				<<if $underwater is 1>>
					fading into the murk
				<<else>>
					falling to the ground
				<</if>>
				with a hiss.</span>
			<</if>>
		<</if>>
	<<else>>
		<<if $worn.under_lower.vagina_exposed is 1 and $worn.lower.vagina_exposed is 1 and playerChastity()>>
			Several tentacles worm their way around your legs.
			They slither into your $worn.genitals.name, seemingly being puppeteered by the pale figure. It closes its fist, and the tentacles pull with an impossible force,
			<<if $worn.genitals.name.includes("gold")>>
				causing you immense pain as they struggle against the shining metal. You hear sizzling, and it seems to be harming the tentacles. <<gpain>><<pain 6>>
				<br><br>
				With one final pull, the metal fractures and splinters, sending shards of gold clattering to the ground as your $worn.genitals.name yields and shatters in a bright flash of light. Both the figure and the tentacles seem to be considerably weaker after the effort.
				<<if $abomination is 1>>
					<<set $enemyhealth -= 150>><<set $enemyarousal += 150>>
				<</if>>
				<<set _tentDefeated to 0>>
				<<for _i to 0; _i lt $tentacles.active; _i++>>
					<<if _tentDefeated gte 3>>
						<<break>>
					<</if>>
					<<if $tentacles[_i].tentaclehealth gt 0>>
						<<set $tentacles[_i].tentaclehealth -= 20>>
						<<set _tentDefeated++>>
					<</if>>
				<</for>>
			<<else>>
				ripping your $worn.genitals.name to shreds.
			<</if>>
			<<set $worn.genitals.type.push("broken")>>
			<<genitalsruined>>
			<<if $vaginalchastityparasite isnot 0 or $analchastityparasite isnot 0 or $penilechastityparasite isnot 0>>
				<<set $vaginalchastityparasite to 0>><<set $analchastityparasite to 0>><<set $penilechastityparasite to 0>>
				<span class="lblue">The parasites within writhe their way out of your body,
				<<if $underwater is 1>>
					fading into the murk
				<<else>>
					falling to the ground
				<</if>>
				with a hiss.</span>
			<</if>>
		<</if>>
	<</if>>
<</widget>>

<<widget "apologyWraith">>
	<<unset $wraithApologise>>
	<br>
	<<He>> freezes, and dissipates slightly. A face you swear you've seen before appears in the mist. <<He>> looks at you with an unreadable expression and raises <<his>> arm, just a bit. <<He>> quickly shies away, reforming the mist around <<himself>>. <span class="green"><<He>> seems unable to act.</span>
	<br><br>
<</widget>>

<<widget "rescueWraith">>
	<<if $location is "forest">>
		<<if $alarm is 1 and $forest lte 20 and $gwylan_aborted isnot 3>>
		<<set $gwylan_aborted to 3>>
			<<if $forest_shop_intro isnot 1 and $gwylan_rescue isnot 1>>
				You see a mousy <<nnpc_gendery "Gwylan">> burst through the treeline, alarmed by your shout.
			<<else>>
				You see Gwylan burst through the treeline, alarmed by your shout.
			<</if>>
			<<nnpc_He "Gwylan">> looks around, puzzled. <<nnpc_His "Gwylan">> gaze passes right over you, as if you weren't there, <span class="red">then turns and walks away.</span>
			<br><br>
		<<elseif $alarm is 1 and $forest gte 21>>
			<<forestRescueFail>>
			<br><br>
		<</if>>
	<</if>>
<</widget>>

<<widget "ejacW">>
	<<if $wraith.gen is "slime">>
		The <<person>> raises <<his>> hand. Incorporeal lines of energy flow to <<him>> from the slimes. They disengage, retreating back to the <<person>>. <<He>> picks one up, and begins to pet it.
	<<else>>
		<<ejaculation>>
	<</if>>
<</widget>>

<<widget "ejaculation-wraith">>
	<<if !_ejacRepeatFix>>
		<<switch $wraith.gen>>
			<<case "man">>
				<<He>> glows a bright white.
			<<case "abomination">>
				<<He>> glows a bright white, and begins laughing. <<His>> pale tentacles disperse in the radiance.
			<<case "tentacles" "slimetentacles">>
				<<He>> pulls back <<his>> hand, and <<his>> eyes flash <<wraithEyes>>. The tentacles retreat from you, back to <<his>> side.<<if $wraith.gen is "slimetentacles">> The slimes quickly follow.<</if>>
			<<case "arms">>
				<<set $enemyno to 1>>
				<<He>> glows a bright white, and begins laughing.<<set $NPCList[0].intro to 0>> <<He>> begins to make strange gestures with <<his>> extra arms.
				<<set _ejacRepeatFix to true>>
			<<default>>
		<</switch>>
		<!-- Temporary until Wraith has its own bodyliquid -->
		<<for _nn to 0;_nn lt $enemynomax; _nn++>>
			<<if $NPCList[_nn].penis is "vagina">>
				<<vaginalejacstat>><<ejacstat>><<set $hygiene += 500>><<bodyliquid "vagina" "semen">>
				<<recordVaginalSperm "pc" $NPCList[_nn] `($enemytype is "man" ? "human" : $NPCList[_nn].type)`>>
			<<elseif $NPCList[_nn].penis is "anus">>
				<<analejacstat>><<ejacstat>><<set $hygiene += 500>><<bodyliquid "anus" "semen">>
				<<recordAnusSperm "pc" $NPCList[_nn] `($enemytype is "man" ? "human" : $NPCList[_nn].type)`>>
			<</if>>
		<</for>>
		<<if $pain gte 100>>
			<<He>> seems to revel in your suffering.
		<<elseif C.npc["Ivory Wraith"].lust gte random(10,30) and $wraith.state is "haunt" and !playerIsPregnant()>>
			<<His>> body flickers and <span class="red">something strikes your stomach</span>. You double over and <<he>> <<if ["abomination","arms"].includes($wraith.gen)>>laughs louder<<else>>laughs<</if>>.
			<<gstress>><<gtrauma>><<gpain>><<violence 10>>
		<</if>>
		<br><br>
	<</if>>
<</widget>>

<<widget "kissWraith">>
	<<if _args[0] is "stress" and $stress gte $stressmax>>
		<<set $_wraithStress to true>>
	<</if>>
	<<He>> approaches you,
	<<if $wraith.type is "tentacles" or $wraith.gen is "abomination">>
		pushing some tentacles aside.
		<<if $tentacleMouth>>
			<<set $_outof to (["tentacle", "tentacledeep"].includes($mouthstate) ? "out of" : "away from")>>
			<<He>> <span class="lblue">yanks the $tentacleMouth $_outof your mouth.</span>
		<</if>>
	<<else>>
		<<if C.npc["Ivory Wraith"].lust gte 16>>
			grabbing your hair in a painful grip with <<if $wraith.gen is "arms">>more than two<<else>>both<</if>> hands.
			<<trauma 12>><<stress 6>><<arousal 1000>>
		<<elseif C.npc["Ivory Wraith"].lust gte 11>>
			holding the back of your neck with one hand.
			<<trauma 6>><<arousal 500>>
		<<else>>
			cupping your cheek with a surprising gentleness.
		<</if>>
	<</if>>
	<<He>> kisses you, and your ears immediately begin to ring. Your fingers and toes go cold, and your face becomes fiery hot.
	Until it, too, grows cold. You feel as though some part of you was drained away.
	<<takeKissVirginity "Ivory Wraith" "rape">>
	<<arousal 2000 "mouth">><<gggarousal>>
	<<trauma 30>><<gggtrauma>><<purity -50>><<lllpurity>><<physique_loss 16>><<llphysique>>
	<<if $pain lt 100>>
		<<pain -15>><<llpain>>
	<</if>>
	<<if $arousal gte $arousalmax>>
		<br><br>
		<<orgasm>>
		Your climax is torturous and painful as you writhe against <<him>>. <<His>> assault only grows more intense. You feel weak.
		<<trauma 30>><<gggtrauma>><<purity -25>><<llpurity>><<physique_loss 8>><<lphysique>><<awareness -20>><<lllawareness>><<gobsession>>
		<<if $_wraithStress>>
			<<set $stress to $stressmax>>
		<</if>>
	<</if>>
<</widget>>

<<widget "wHunt">>
	<<if !$possessed>>
		<<switch _args[0]>>
			<<case "town">>
				<<if wraithCanHunt() and $wraith.state and $wraith.hunt is 0 and $wraith.timer gte (random(0, 50))>>
					<br><br>
					<<set $wraith.hunt to 1>>
					A wave of dizziness and confusion washes over you. Every time you blink, you see a blurred image.
					<br>
					You hold your eyes shut, and it begins to come into focus. You see a tall robed figure, bathed in red moonlight, its skin as pale as ivory. As soon as you see it, you can't help but think that it sees you too. <<stress 6>><<gstress>><<trauma 6>><<gtrauma>>
					<br>
					<<if $wraith.state is "haunt">>
						<span class="red">You are being hunted.</span>
					<<else>>
						<span class="red">Dread lingers in the air.</span>
					<</if>>
				<<elseif $wraith.hunt>>
					<<if $moonstate is "morning" and Time.hour gte 6>>
						<br><br>
						With the rising of the sun, you feel a sense of relief. The dread passes. <span class="blue"><i>You're safe until the next blood moon.</i></span>
						<<clearWraith>>
					<<elseif $wPersist is 1>>
						<<set $wPersist to 2>>
						<br><br>
						The feeling of dread remains. Something's wrong. <span class="red">Whatever was hunting you is still coming.</span><<stress 3>><<gstress>>
					<<elseif $wraith.state is "haunt">>
						<span class="red">Something terrible is hunting you.</span>
						<<set $wraith.hunt += (0.5 + (C.npc["Ivory Wraith"].lust / 40))>>
						<<if $wraith.hunt gte ($rng / 10)>>
							<<set $eventforced to true>>
						<</if>>
					<<else>>
						<span class="red">Something unnatural stalks the streets.</span>
						<<set $wraith.hunt += (0.5 + (C.npc["Ivory Wraith"].lust / 40))>>
						<<if $wraith.hunt gte ($rng / 10)>>
							<<set $eventforced to true>>
						<</if>>
					<</if>>
				<</if>>
			<<case "forest">>
				<<if $wraith.hunt is 0>>
					<<set $rng2 to random(1, 3)>>
					<<if $rng2 is 1 and $edenfreedom gte 1>>
						A chill runs up your spine, a warning from some primal instinct. <span class="red">Something is hunting you.</span>
						<<set $edenforesthunt to 1>>
						<<set $blackwolfhunt to 0>>
					<<else>>
						A wave of dizziness and confusion washes over you. Every time you blink, you see a blurred image.
						<br>
						You hold your eyes shut, and it begins to come into focus. You see a tall robed figure, bathed in red moonlight, its skin as pale as ivory. As soon as you see it, you can't help but think that it sees you too. <<stress 6>><<gstress>><<trauma 6>><<gtrauma>>
						<br>
						<span class="red">Something is hunting you.</span>
						<<set $edenforesthunt to 0>>
						<<set $blackwolfhunt to 0>>
					<</if>>
					<<set $wraith.hunt to 1>>
				<<else>>
					You begin to see strange shapes in the air around you. A chill runs up your spine. <span class="red">Something is still hunting you.</span>
					<<set $edenforesthunt to 0>>
					<<set $blackwolfhunt to 0>>
				<</if>>
				<<set $foresthunt to $wraith.hunt>>
				<br><br>
				<<link [[Next|Forest]]>><<set $eventskip to 1>><</link>>
			<<case "drain">>
				<<if wraithCanHunt() and $wraith.state and $wraith.hunt is 0 and $wraith.timer gte (random(0, 60))>>
					<<set $wraith.hunt to 1>>
					<br><br>
					A wave of dizziness and confusion washes over you. Every time you blink, you see a blurred image.
					<br>
					You hold your eyes shut, and it begins to come into focus. You see a tall robed figure, bathed in red moonlight, its skin as pale as ivory. As soon as you see it, you can't help but think that it sees you too. <<stress 6>><<gstress>><<trauma 6>><<gtrauma>>
					<br>
					<<if $wraith.state is "haunt">>
						<span class="red">You are being hunted.</span>
					<<else>>
						<span class="red">Dread lingers in the air.</span>
					<</if>>
				<<elseif $wraith.hunt>>
					<<if $moonstate is "morning" and Time.hour gte 6>>
						<br><br>
						As the first rays of sunlight trickle through open manholes and grates, you feel a sense of relief. The dread passes. <span class="blue"><i>You're safe until the next blood moon.</i></span>
						<<clearWraith>>
					<<elseif $wraith.state is "haunt">>
						<span class="red">Something terrible is hunting you.</span>
						<<set $wraith.hunt += (0.5 + (C.npc["Ivory Wraith"].lust / 40))>>
						<<if $wraith.hunt gte ($rng / 10)>>
							<<set $eventforced to true>>
						<</if>>
					<<else>>
						<span class="red">Something unnatural stalks the streets above.</span>
						<<set $wraith.hunt += (0.5 + (C.npc["Ivory Wraith"].lust / 40))>>
						<<if $wraith.hunt gte ($rng / 10)>>
							<<set $eventforced to true>>
						<</if>>
					<</if>>
				<</if>>
			<<case "sewers">>
				<<if wraithCanHunt() and $wraith.state and $wraith.hunt is 0 and $wraith.timer gte (random(0, 60))>>
					<<set $wraith.hunt to 1>>
					<br><br>
					A wave of dizziness and confusion washes over you. Every time you blink, you see a blurred image.
					<br>
					You hold your eyes shut, and it begins to come into focus. You see a tall robed figure, bathed in red moonlight, its skin as pale as ivory. As soon as you see it, you can't help but think that it sees you too. <<stress 6>><<gstress>><<trauma 6>><<gtrauma>>
					<br>
					<<if $wraith.state is "haunt">>
						<span class="red">You are being hunted.</span>
					<<else>>
						<span class="red">Dread lingers in the air.</span>
					<</if>>
				<<elseif $wraith.hunt>>
					<<if $moonstate is "morning" and Time.hour gte 6>>
						<br><br>
						You feel a sense of relief, and instinctively know the sun has risen. The dread passes. <span class="blue"><i>You're safe until the next blood moon.</i></span>
						<<clearWraith>>
					<<elseif $wraith.state is "haunt">>
						<span class="red">Something terrible is hunting you.</span>
						<<set $wraith.hunt += (0.5 + (C.npc["Ivory Wraith"].lust / 40))>>
						<<if $wraith.hunt gte ($rng / 10)>>
							<<set $eventforced to true>>
						<</if>>
					<<else>>
						<span class="red">Something unnatural stalks the sewers.</span>
						<<set $wraith.hunt += 0.5>>
						<<if $wraith.hunt gte ($rng / 10)>>
							<<set $eventforced to true>>
						<</if>>
					<</if>>
				<</if>>
			<<case "lake">>
				Your ears begin to ring, and you feel like you're being watched. Out of instinct, you turn around.
				<br><br>
				<<if $bus is "lakeshore" or $bus is "lakeshallows" or $bus is "lakedepths">>
					A beautiful pale figure hovers over the centre of the lake. You see a long stream of silver hair flowing in the wind. As soon as you see it, it vanishes. <<stress 6>><<gstress>>
					<br><br>
				<<elseif $location is "lake_ruin">>
					A beautiful pale figure floats in the water. Long streams of silver hair flow in the current. As soon as you see it, it vanishes. <<stress 6>><<gstress>>
					<br><br>
				<<else>>
					For a moment, you think you see the shape of a pale face between the trees. <<stress 6>><<gstress>>
					<br><br>
				<</if>>
				<span class="red">You're trespassing. Something is hunting you.</span>
				<<set $edenforesthunt to 0>>
				<<set $blackwolfhunt to 0>>
				<<set $wraith.hunt to 1>>
				<<set $foresthunt to $wraith.hunt>>
				<br><br>
				<<set $eventskip to 1>>
				<<if $location is "lake_ruin">>
					<<destinationlakeruin>>
				<<else>>
					<<if Time.season is "winter" and ($bus is "lakeshallows" or $bus is "lakedepths")>>
						<<destination_lake_ice>>
					<<else>>
						<<destinationlake>>
					<</if>>
				<</if>>
		<</switch>>
	<</if>>
<</widget>>

<<widget "wPersist">>
	<<if $wraith.state and !$possessed>>
		<<if $wraith.hunt and wraithCanHunt()>>
			<<if _args[0] is "forest">>
				<<if $foresthunt gte 1>>
					<<set $wraith.hunt to $foresthunt>>
					<<if !$wPersist>>
						<<set $wPersist to 1>>
					<</if>>
				<<else>>
					<<set $foresthunt to $wraith.hunt>>
					You enter the treeline, <span class="red"> but can't shake the feeling that something's still coming for you.</span>
				<</if>>
				<<if ($location is "lake" or $location is "lake_ruin") and !$possessed>>
					<<set $wraith.hunt += 1.5>>
					<<set $foresthunt += 1.5>>
					<<if $moonstate is "morning" and Time.hour gte 6>>
						With the rising of the sun, you feel a sense of relief. The dread passes. <span class="blue"><i>You're safe until the next blood moon.</i></span>
						<<clearWraith>>
						<br><br>
					<<else>>
						<<rng 60>>
						<<if $rng lte 20>>
						<span class="red">You are being hunted. Red moonlight reflects off of the water.</span> <<stress 6>><<gstress>>
						<br><br>
						<<elseif $rng lte 40>>
						<span class="red">You are being hunted. You hear distant laughter.</span> <<trauma 6>><<gtrauma>>
						<br><br>
						<<else>>
						<span class="red">You are being hunted. You feel a pressure building around you.</span> <<stress 6>><<gstress>><<trauma 6>><<gtrauma>>
						<br><br>
						<</if>>
					<</if>>
				<</if>>
			<</if>>
		<<elseif wraithCanHunt() and !$possessed>>
			<<wTimerProgress>>
		<</if>>
	<</if>>
<</widget>>

<<widget "wTimerProgress">>
	<<if $wraith.state and $wraith.hunt is 0 and isBloodmoon()>>
		<<set $wraith.timer++>>
		<<set $wraith.timer += Math.floor(C.npc["Ivory Wraith"].lust / 10)>>
		<<if $rng gte 60 and ($parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime")>>
			You hear the slime in your ear make an unusual sound, <span class="red">as if it's calling out to something.</span>
			<<set $wraith.timer++>>
		<</if>>
	<</if>>
<</widget>>

<<widget "exitWraith">>
	<<switch $wraith.exit>>
		<<case "home">>
			<<link [[Next|Bedroom]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "sleep">>
			<<set $wardrobe_location to "wardrobe">>
			<<wardrobeSelection true>>
			<<radiooutfits>>
			<br><br>
			<<link [[Next|Bedroom]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "cabin">>
			<<link [[Next|Eden Cabin]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "alex_cottage">>
			<<link [[Next|Farm Cottage]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "tower">>
			<<link [[Next|Bird Tower]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "town">>
			<<destinationeventend>>
			<<endevent>>
		<<case "forest">>
			<<link [[Next|Forest]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "lake_ruin">>
			<<destinationlakeruin>>
			<<endevent>><<set $eventskip to 1>>
		<<case "lake">>
			<<if Time.season is "winter" and ($bus is "lakedepths" or $bus is "lakeshallows")>>
				<<destination_lake_ice>>
			<<else>>
				<<destinationlake>>
			<</if>>
			<<endevent>><<set $eventskip to 1>>
		<<case "wolf_cave">>
			<<link [[Next|Wolf Cave]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "moor">>
			<<link [[Next|Moor]]>><<endevent>><<set $eventskip to 1>><</link>>
			<br>
		<<case "farm_assault">>
			<<link [[Next|Farm Assault]]>><<endevent>><</link>>
			<br>
		<<case "sewers">>
			<<destinationsewers>>
			<<endevent>><<set $eventskip to 1>>
		<<default>>
			<span class="red">Something went wrong. There's nowhere to place you due to a failure of the Wraith's code. Please inform PurityGuy.</span>
			<br><br>
			Offending event: $passage | Location: $location ($bus) | Exit: $wraith.exit
			<br><br>
			<<endWraith>>
			<<clearWraith>>
			<<link [[Portal to the bedroom|Bedroom]]>><<endevent>><<set $eventskip to 1>><<hallucinogen 180>><</link>><<gghallucinogens>>
			<br>
	<</switch>>
	<<if !_args[0]>>
		<<endWraith>>
	<</if>>
<</widget>>

<<widget "rngWraith">>
	<<if $wraith.state>>
		<<if _args[1] is "night" and Time.dayState isnot "night" or _args[1] is "noBlood" and isBloodmoon()>>
			<<set _wraithEvent to false>>
		<<else>>
			<<set _rngWraith to 2 + (Math.floor(C.npc["Ivory Wraith"].lust / 10))>>
			<<if Time.dayState is "night">>
				<<set _rngWraith += 2>>
			<</if>>
			<<set _wraithHallucinations to (_args[0] is 1 or _args[0] is 2 ? _args[0] : 0)>>
			<<if ($hallucinations gte _wraithHallucinations and _rngWraith gte random(1,100)) or isBloodmoon()>>
				<<set _wraithEvent to true>>
			<</if>>
		<</if>>
	<</if>>
<</widget>>

<<widget "rngWraithSocial">>
	<<if $wraith.state and !_rngWraithSocialCheck>>
		<<set _rngWraithSocialCheck to true>>
		<<set _rngWraithFace to ($wraith.type ? Math.ceil(Math.random() * 10) : Math.ceil(Math.random() * 30))>>
		<<set _rngWraithLineChance to Math.ceil(Math.random() * 15)>>
		<<set _rngWraithSocial to 2 + (Math.floor(C.npc["Ivory Wraith"].lust / 10))>>
		<<if Time.dayState is "night">>
			<<set _rngWraithSocial += 2>>
		<</if>>
		<<if ($hallucinations gte 1 and _rngWraithSocial gte Math.ceil(Math.random() * 100)) or isBloodmoon()>>
			<<set _wraithEventSocial to true>>
		<</if>>
		<<if $wraith.mimic isnot "" and $wraith.revealed>>
			<<set _wraithTitle to "pretender">>
		<<else>>
			<<switch $wraith.type>>
				<<case "tentacles">><<set _wraithTitle to "writhing">>
				<<case "abomination">><<set _wraithTitle to "profane">>
				<<case "arms">><<set _wraithTitle to "vain">>
				<<default>><<set _wraithTitle to (["haunt", "despair"].includes($wraith.state) ? "forlorn" : "reflection")>>
			<</switch>>
		<</if>>
	<</if>>
<</widget>>

<<widget "wraithEventStreet">>
	<<set $wraith.exit to "town">>
	<<if $wraith.hunt gte 10>>
		<<if !$wraithIntro>>
			<<wraithIntro>>
		<<else>>
			<<wraithCaught>>
		<</if>>
	<<else>>
		<<cleareventpool>>
		<<if $wraith.hunt gte 5>>
			<<if !$wraithIntro>>
				<<addevent "wraithIntro" 0.1>>
			<<else>>
				<<addinlineevent "wraithClose1" 0.1>>
				As you walk, your footfalls become lighter. You're having trouble breathing<<if $exposed lte 0>>, and your clothes feel heavy<</if>>. <<rainWraith true>>
				<br><br>
				Your ears begin to ring, and you see something taking shape in the $weather.
				A beautiful pale figure floats just above the ground, wearing translucent white robes that flow in the wind. Its eyes flash a bright <<wraithEyes>> as it sees you. Your mind feels cloudy as you see shapes dancing in the air and behind its eyes.
				<br><br>
				Before you can look away, it makes a hypnotic motion with its hands.
				<<if $wraith.state is "haunt">>
					It then raises a hand to its neck, seemingly trying to grab something that isn't there. Its hand clenches.
					<br><br>
					"<span class="wraith">Thief. You will never be free again.</span>"
					<br><br>
					<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
						<span class="lewd">You feel the slime in your head command you to</span> <span class="red">give it back.</span>
						<br><br>
					<</if>>
				<<elseif $wraith.state is "despair">>
					It then raises a hand to its neck, seemingly trying to grab something that isn't there. Its hand clenches.
					<br><br>
					"<span class="wraith">It's so cold. You're so warm.</span>"
					<br><br>
					<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
						<span class="lewd">You feel the slime in your head command you to</span> <span class="red">kneel.</span>
						<br><br>
					<</if>>				
				<<else>>
					It raises a hand to its chest, rubbing its ivory necklace. The glint of the inlaid blue gemstones match its glowing eyes.
					<br><br>
					"<span class="wraith">Kneel.</span>"
					<br><br>
					<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
						<span class="lewd">You feel the slime in your head command you to kneel.</span>
						<br><br>
					<</if>>
				<</if>>
				<<link [[Give in|Wraith Caught Obey]]>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<corruption 1>><<pain -4>><<stress -6>><<trauma -12>><</if>><<sub 1>><</link>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<gcorruption>><<lpain>><<lltrauma>><<lstress>><</if>>
				<br>
				<<link [[Try to look away|Wraith Caught Resist]]>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<corruption -1>><<pain 8>><<stress 6>><<trauma 6>><</if>><<def 1>><</link>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<lcorruption>><<ggpain>><<ggtrauma>><<ggstress>><</if>><<willpowerdifficulty 1 $willpowermax>>
				<br>
				<</addinlineevent>>
				<<addinlineevent "wraithClose2" 0.1>>
					Something whispers your name directly in your ear. You flail to the side, but there's nothing there.
					<<if $loveInterest.primary isnot "None" and $loveInterest.primary isnot "Black Wolf" and $loveInterest.primary isnot "Great Hawk">>
						You think it sounded like $loveInterest.primary. <<if $wraith.seen gte 5>>You know better, though.<</if>>
					<</if>>
					<br><br>
					When you turn around, your blood freezes. The pale figure <<if $location is "park">>floats atop the fountain<<else>>stands at the end of the street<</if>>. <<rainWraith>>
					<br><br>
					<<link [[Run|Wraith Run]]>><</link>><<athleticsdifficulty 800 1500>>
					<br>
					<<link [[Hide (0:10)|Wraith Hide]]>><<pass 10>><</link>>
					<br>
				<</addinlineevent>>
				<<addinlineevent "wraithClose3" 0.1>>
					<<if $tentacledisable is "f">>
						You see a blur of white from the corner of your eye, and feel something touch your thighs. You look down to see a pale tentacle extending from an open manhole. <span class="red">You feel whatever's hunting you drawing near.</span>
						<br><br>
						<<link [[Grab the tentacle|Wraith Tentacle Grab]]>><</link>><<physiquedifficulty 6000 16000>><<deviant1>>
						<br>
						<<if $deviancy gte 75>>
							<<link [[Offer yourself|Wraith Tentacle Rape]]>><<set $molestationstart to 1>><</link>><<deviant5>>
							<br>
						<</if>>
						<<link [[Try to run|Wraith Tentacle Run]]>><<stress 3>><<trauma 3>><</link>><<gtrauma>><<gstress>>
						<br>
					<<else>>
						You see a blur of white from the corner of your eye, and feel something grab your ankle. You immediately try to jump back, but trip as it tightens its grip. <<pain 2>><<gpain>>
						<br><br>
						You look down to see a pale hand retreating into a storm drain. <<stress 6>><<gstress>>
						<br><br>
						You scramble to your feet and keep moving.
						<br><br>
						<<set $wraith.hunt++>>
						<<destinationeventend>>
					<</if>>
				<</addinlineevent>>
				<<addinlineevent "wraithClose4" 0.2>>
					Everything around you is bathed in red light. As you walk, you notice large spans of time where there seems to be no one else around.
					<br><br>
					You're not sure whether this is a reprieve, or a sign of something much worse.
					<br><br>
					<<destinationeventend>>
				<</addinlineevent>>
				<<addinlineevent "wraithClose5" 0.1>>
					You hear an intense rumbling from under you. It sounds like it's coming from the sewers. You see a massive column of water shoot up from an open manhole, carrying water high into the air.
					<br><br>
					The rumbling becomes heavier. A drainage grate much closer to you erupts in water. You look down, and realise you're standing right on top of a grate.
					<br><br>
					<<if (currentSkillValue('danceskill') + $rng) gte 800>>
						Thanks to your agility, you <span class="green"> reflexively pivot and throw yourself out of the way</span> as another column of water shoots up.
					<<else>>
						You try to throw yourself out of the way, but <span class="red">you're too slow.</span> You're soaked by a column of water from below.
						<<water>><<effectswater>><<exposure>><<covered>>
					<</if>>
					<br><br>
					A final water spout shoots up from another manhole far behind you. You see a ghostly pale figure standing at the crest, surrounded by translucent watery tendrils. <<stress 12>><<ggstress>>
					<br><br>
					You run in the opposite direction.
					<<set $wraith.hunt++>>
					<br><br>
					<<exitWraith>>
				<</addinlineevent>>
			<</if>>
		<</if>>
		<<addinlineevent "wraith1" 0.2>>
			From the corner of your eye, you catch a glimpse of a pale face watching you from
			<<if $location is "park">>
				behind a tree.
			<<else>>
				a high window.
			<</if>>
			When you blink, it's gone. <<stress 6>><<gstress>>
			<br><br>
			<<destinationeventend>>
		<</addinlineevent>>
		<<addinlineevent "wraith2" 0.1>>
			You think you hear someone call your name. You don't see a single person around you. <<stress 6>><<gstress>>
			<br><br>
			<<destinationeventend>>
		<</addinlineevent>>
		<<addinlineevent "wraith3" 0.1>>
			<<generate1>><<person1>>A <<person>> runs by, nearly knocking you over. <<Hes>> barely staying on <<his>> feet, and keep looking towards you with panic.
			<br><br>
			You realise <<hes>> looking behind you. You turn, but there's nothing except
			<<if $location is "park">>
				the empty park.
			<<else>>
				empty streets.
			<</if>>
			<br><br>
			<<endevent>>
			<<destinationeventend>>
		<</addinlineevent>>
		<<addinlineevent "wraith4" 0.2>>
			Red moonlight reflects off distant windows and parked cars. As eerie as the atmosphere is, you can't deny that it's also rather beautiful. <<stress -3>><<lstress>>
			<br><br>
			<<destinationeventend>>
		<</addinlineevent>>
		<<addinlineevent "wraith5" 0.1>>
			As you pass over a grate, you hear a faint rumbling from down below. It gets louder the longer you listen.
			<br><br>
			You decide not to linger.
			<br><br>
			<<destinationeventend>>
		<</addinlineevent>>
		<<addinlineevent "wraithEventSkip" 0.3>>
			<<set _wraithEventSkipped to true>>
			<<eventsstreet>>
		<</addinlineevent>>
		<<runeventpool>>
	<</if>>
<</widget>>

<<widget "wraithEventSewers">>
	<<set $wraith.exit to "sewers">>
	<<if $wraith.hunt gte 10>>
		<<if !$wraithIntro>>
			<<wraithIntro>>
		<<else>>
			<<wraithCaught>>
		<</if>>
	<<else>>
		<<cleareventpool>>
		<<if $wraith.hunt gte 5>>
			<<if !$wraithIntro>>
				<<addevent "wraithIntro" 0.1>>
			<<else>>
				<<addinlineevent "wraithClose1" 0.1>>
					As you walk, your footfalls become lighter. You're having trouble breathing<<if $exposed lte 0>>, and your clothes feel heavy<</if>>. <<rainWraith true>>
					<br><br>
					Your ears begin to ring, and you see something taking shape in the fog.
					A beautiful pale figure floats just above the ground, wearing translucent white robes that flow in the wind. Its eyes flash a bright <<wraithEyes>> as it sees you. Your mind feels cloudy as you see shapes dancing in the air and behind its eyes.
					<br><br>
					Before you can look away, it makes a hypnotic motion with its hands.
					<<if $wraith.state is "haunt">>
						It then raises a hand to its neck, seemingly trying to grab something that isn't there. Its hand clenches.
						<br><br>
						"<span class="wraith">Thief. You will never be free again.</span>"
						<br><br>
						<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
							<span class="lewd">You feel the slime in your head command you to</span> <span class="red">give it back.</span>
							<br><br>
						<</if>>
					<<elseif $wraith.state is "despair">>
						It then raises a hand to its neck, seemingly trying to grab something that isn't there. Its hand clenches.
						<br><br>
						"<span class="wraith">It's so cold. You're so warm.</span>"
						<br><br>
						<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
							<span class="lewd">You feel the slime in your head command you to</span> <span class="red">kneel.</span>
							<br><br>
						<</if>>
					<<else>>
						It raises a hand to its chest, rubbing its ivory necklace. The glint of the inlaid blue gemstones match its glowing eyes.
						<br><br>
						"<span class="wraith">Kneel.</span>"
						<br><br>
						<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
							<span class="lewd">You feel the slime in your head command you to kneel.</span>
							<br><br>
						<</if>>
					<</if>>
					<<link [[Give in|Wraith Caught Obey]]>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<corruption 1>><<pain -4>><<stress -6>><<trauma -12>><</if>><<sub 1>><</link>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<gcorruption>><<lpain>><<lltrauma>><<lstress>><</if>>
					<br>
					<<link [[Try to look away|Wraith Caught Resist]]>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<corruption -1>><<pain 8>><<stress 6>><<trauma 6>><</if>><<def 1>><</link>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<lcorruption>><<ggpain>><<ggtrauma>><<ggstress>><</if>><<willpowerdifficulty 1 $willpowermax>>
					<br>
				<</addinlineevent>>
				<<addinlineevent "wraithClose2" 0.1>>
					<<if $tentacledisable is "f">>
						You see a blur of white from the corner of your eye, and feel something touch your thighs. You look down to see a pale tentacle extending from the canal. <span class="red">You feel whatever's hunting you drawing near.</span>
						<br><br>
						<<link [[Grab the tentacle|Wraith Tentacle Grab]]>><</link>><<physiquedifficulty 6000 16000>><<deviant1>>
						<br>
						<<if $deviancy gte 75>>
							<<link [[Offer yourself|Wraith Tentacle Rape]]>><<set $molestationstart to 1>><</link>><<deviant5>>
							<br>
						<</if>>
						<<link [[Try to run|Wraith Tentacle Run]]>><<stress 3>><<trauma 3>><</link>><<gtrauma>><<gstress>>
						<br>
					<<else>>
						You see a blur of white from the corner of your eye, and feel something grab your ankle. You immediately try to jump back, but trip as it tightens its grip. <<pain 2>><<gpain>>
						<br><br>
						You look down to see a pale hand retreating into a storm drain. <<stress 6>><<gstress>>
						<br><br>
						You scramble to your feet and keep moving.
						<br><br>
						<<set $wraith.hunt++>>
						<<destinationsewers>>
					<</if>>
				<</addinlineevent>>
				<<addinlineevent "wraithClose3" 0.1>>
					You notice the ceiling glisten.
					<<if $slimedisable is "f">>
						A sticky substance drops to the floor with a splat. It's thick, slimy and pale. It shambles toward you, and more appear from the fog.
						<br><br>
						<<link [[Next|Wraith Sewers Struggle]]>><<set $struggle_start to 1>><</link>>
					<<else>>
						You step to the side just as a pale slime drops to the floor with a splat. You run before it gives chase, but feel whatever's hunting you draw closer. <<stress 6>><<gstress>>
						<br><br>
						<<set $wraith.hunt++>>
						<<destinationsewers>>
					<</if>>
				<</addinlineevent>>
			<</if>>
		<</if>>
		<<addinlineevent "wraith1" 0.2>>
			From the corner of your eye, you catch a glimpse of a pale face watching you from the shadows. When you blink, it's gone. <<stress 6>><<gstress>>
			<br><br>
			<<destinationsewers>>
		<</addinlineevent>>
		<<addinlineevent "wraith2" 0.1>>
			You think you hear someone call your name. You don't see a single person around you. <<stress 6>><<gstress>>
			<br><br>
			<<destinationsewers>>
		<</addinlineevent>>
		<<addinlineevent "wraith3" 0.1>>
			The water churns unnaturally, before leaping at you. You jump back, but the water stops in midair. It slowly retreats back into the canal, as if changing its mind. <<stress 6>><<gstress>>
			<br><br>
			<<destinationsewers>>
		<</addinlineevent>>
		<<addinlineevent "wraithEventSkip" 0.1>>
			<<set _wraithEventSkipped to true>>
			<<eventssewers>>
		<</addinlineevent>>
		<<runeventpool>>
	<</if>>
<</widget>>

<<widget "wraithIntro">>
	<<set $wraithIntro to true>>
	As you walk, your footfalls become lighter. You're having trouble breathing<<if $exposed lte 0>>, and your clothes feel heavy<</if>>.
	<br><br>
	<<if $location is "forest" or $location is "lake">>
		You steady yourself against a tree, panting. You look around, and notice that everything's gone quiet.
		<<switch $weather>>
			<<case "snow">>
				A cold breeze accompanies the snowfall. You look back, finding your footprints already covered. You've completely lost your sense of direction.
			<<case "rain">>
				Only the rain breaks the silence.
			<<default>>
				<<if Time.season is "winter">>
					The snow falls quietly. You don't remember when it started snowing, though. <<rainWraith>>
				<<else>>
					Only the rain breaks the silence. You don't remember when it started raining, though. <<rainWraith>>
				<</if>>
		<</switch>>
		Your ears begin to ring.
		<br><br>
		The shape of a person begins to form in the $weather, and your pulse quickens.
	<<elseif $location is "sewers">>
		<<rainWraith>>
		The air around you chills. You swear you feel $weather on your skin, but there is no $weather in the sewers. Only a rapidly expanding fog.
		<br><br>
		Your ears begin to ring. An image starts to take shape in the fog, and your pulse quickens.
	<<else>>
		You look around. The area is completely devoid of people. You take a moment to steady yourself. The image of the robed figure slowly fades from your head. <<rainWraith true>>
		<br><br>
		Your ears begin to ring. An image starts to take shape in the $weather, and your pulse quickens.
	<</if>>
	You try to turn and run, but your legs won't move, and you can't help but look.
	A beautiful pale figure floats just above the ground, wearing translucent white robes that flow in the wind. Its eyes flash a bright <<wraithEyes>> as it sees you.
	<<if $wraith.state is "haunt">>
		It raises a hand to its scarred neck, seemingly trying to grab something that isn't there.
		<br><br>
		"<span class="wraith">Thief. Give it back, or <<if $weather is "snow">>this blizzard will freeze you<<else>>this deluge will drown you<</if>>.</span>"
		<br><br>
		<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
			<span class="lewd">You feel the slime in your head command you to</span> <span class="red">give it back.</span>
			<br><br>
		<</if>>
	<<elseif $wraith.state is "despair">>
		It then raises a hand to its neck, seemingly trying to grab something that isn't there. Its hand clenches.
		<br><br>
		"<span class="wraith">H...have you seen my necklace?</span>"
		<br><br>
		<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
			<span class="lewd">You feel the slime in your head command you to</span> <span class="red">kneel.</span>
			<br><br>
		<</if>>	
	<<else>>
		It raises a hand to its chest, rubbing its ivory necklace. The glint of the inlaid blue gemstones match its glowing eyes.
		<br><br>
		"<span class="wraith">A poor, lonely soul. Come. I will make us beautiful.</span>"
		<br><br>
		<<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">>
			<span class="lewd">You feel the slime in your head command you to kneel.</span>
			<br><br>
		<</if>>
	<</if>>
	<<link [[Give in|Wraith Caught Obey]]>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<corruption 1>><<pain -4>><<stress -6>><<trauma -12>><</if>><<sub 1>><</link>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<gcorruption>><<lpain>><<lltrauma>><<lstress>><</if>>
	<br>
	<<link [[Try to look away|Wraith Caught Resist]]>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<corruption -1>><<pain 8>><<stress 6>><<trauma 6>><</if>><<def 1>><</link>><<if $parasite.left_ear.name is "slime" or $parasite.right_ear.name is "slime">><<lcorruption>><<ggpain>><<ggtrauma>><<ggstress>><</if>><<willpowerdifficulty 250 $willpowermax>>
	<br>
	<<if $angel gte 6>>
		<<link [[Pray|Wraith Intro Pray]]>><</link>><<angel>>
		<br>
	<</if>>
<</widget>>

<<widget "wraithCaught">>
	<<rainWraith>>
	<<if $passage is "Lake Meditate">>
		You're suddenly snapped out of your meditation. Your arms<<if $exposed lte 0>> and clothes<</if>> grow heavy, and you feel like you're floating.
		<br><br>
		As soon as you look behind you, you feel something violently grab into your neck and lift you clear off the ground.
		<br><br>
		<<if $wraithIntro>>
			A pale figure stands before you.
			<<if $wraith.state is "haunt">>
				It holds a clenched hand to its neck, and bares its teeth at you.
				<br><br>
				"<span class="wraith">Drown.</span>"
			<<elseif $wraith.state is "despair">>
				It holds a clenched hand to its neck, and frowns at you.
				<br><br>
				"<span class="wraith">Where is it? So cold.</span>"				
			<<else>>
				Its necklace shimmers blue, despite the red moonlight.
				<br><br>
				"<span class="wraith">You belong to me.</span>"
			<</if>>
		<<else>>
			<<set $wraithIntro to true>>
			A beautiful pale figure stands before you. It looks you over, before pulling you closer. It's hard to look away.
			<br><br>
			<<if $wraith.state is "haunt">>
				It holds a clenched hand to its scarred neck, and bares its teeth at you.
				<br><br>
				"<span class="wraith">Thief. Give it back.</span>"
			<<elseif $wraith.state is "despair">>
				It holds a clenched hand to its neck, and frowns at you.
				<br><br>
				"<span class="wraith">H...have you seen my necklace?</span>"	
			<<else>>
				Its necklace shimmers blue, despite the red moonlight.
				<br><br>
				"<span class="wraith">Don't resist. I will make us beautiful.</span>"
			<</if>>
		<</if>>
	<<elseif $location is "lake_ruin" or $bus is "lakedepths" or $bus is "lakeshallows">>
		<<if $bus is "lakeshallows" or $bus is "lakedepths">>
			<<set $location to "lake_ruin">>
			<<if Time.season is "winter">>
				You stumble forward, and feel your foot hit ice cold water. You didn't hear any ice break.
				<br><br>
				You look back, and see a pale hand sticking out of the ice without a breach. <span class="red">It pulls, and you begin to pass right through the ice.</span> You have nothing to grab onto, and are helplessly pulled under.
			<<else>>
				You feel a tug on your leg. Without warning, <span class="red">you're pulled under the surface violently.</span>
			<</if>>
			<br><br>
		<<else>>
			You feel a sudden tug downwards. You struggle in the water, but fail to move. You look around, and see many long, translucent limbs ensnaring you.
			<br><br>
		<</if>>
		<<if $wraithIntro>>
			A pale figure floats in the water before you.
			<<if $wraith.state is "haunt" or $wraith.offspring is "dead">>
				It holds a clenched hand to its neck, and bares its teeth at you.
				<br><br>
				"<span class="wraith">Drown.</span>"
			<<elseif $wraith.state is "despair">>
				It holds a clenched hand to its neck, and smiles at you.
				<br><br>
				"<span class="wraith"><<pcPetname "Wraith">>. You've returned. Have you seen my necklace?</span>"					
			<<else>>
				Its necklace shimmers a striking blue, causing reflections in the water all around you.
				<br><br>
				"<span class="wraith">You've returned.</span>"
			<</if>>
		<<else>>
			<<set $wraithIntro to true>>
			A beautiful pale figure encircles you. Long streaks of silver hair flow in the water behind it. It almost seems to be inspecting you.
			<br><br>
			<<if $wraith.state is "haunt">>
				It scratches at its bare neck, and regards you with striking red eyes.
				<br><br>
				"<span class="wraith">Thief. You've returned. Give it back at once.</span>"
			<<elseif $wraith.state is "despair">>
				It holds a clenched hand to its neck, and frowns at you.
				<br><br>
				"<span class="wraith">H...have you seen my necklace?</span>"	
			<<else>>
				It places a hand over its ivory necklace, as if to guard it from you.
				<br><br>
				"<span class="wraith">Trespasser. Do you come to steal from the dead?</span>"
			<</if>>
		<</if>>
	<<else>>
		You suddenly feel like you're walking through waist-high water. Your arms<<if $exposed lte 0>> and clothes<</if>> grow heavy, and your feet don't seem to hit the ground anymore.
		<br><br>
		As soon as you look behind you, you feel something violently grab into your neck and lift you clear off the ground. A pale figure stands before you.
		<<if ["haunt", "despair"].includes($wraith.state)>>
			It has a hand pressed to its own bare neck, and regards you with striking red eyes.
		<<else>>
			Its silver hair flows in a breeze you can't feel. It places its free hand over its necklace.
		<</if>>
		<br><br>
		<<if $wraith.state is "haunt" or $wraith.offspring is "dead">>
			"<span class="wraith">Drown.</span>"
		<<elseif $wraith.state is "despair">>
			"<span class="wraith">So cold. Where is it?</span>"
		<<else>>
			"<span class="wraith">You belong to me.</span>"
		<</if>>
	<</if>>
	<br><br>
	<<generateWraith 1 true>>
	<<initWraith "abomination">>
	<<if $wraith.gen is "abomination">>
		Pale tendrils keep you suspended in place.
	<<else>>
		Many translucent arms swirl behind it.
	<</if>>
	<br><br>
	<<link [[Next|Wraith Caught]]>><</link>>
	<br>
<</widget>>

<<widget "wraith_pass">>
	<<if _args[0]>>
		<<pass _args[0]>>
		<<set $wraithPrison.timer -= _args[0]>>
		<<if $wraithPrison.timer lte 0 and $wraithPrison.state isnot "gone">>
			<<set $wraithPrison.state to "present">>
		<<elseif $wraithPrison.state isnot "gone">>
			<<set $wraithPrison.state to "recovering">>
		<</if>>
		<<set $wraithPrison.timePassed += _args[0]>>
		<<hallucinogen `(_args[0] * 3)`>>
		<<set $arousal += (_args[0] * 3)>>
	<</if>>
<</widget>>

<<widget "wraithPossess">>
	<<set $possessed to true>><<canvas-model-override "blink" false>>
	<<set $controlSaved to $control>><<set $control to 0>>
	<<set $wraith.hunt to 0>>

	<<if _args[0]>>
		<<set $wraith.exit to _args[0]>>
	<</if>>
<</widget>>

<<widget "wraithExorcise">>
	<<unset $possessed>><<canvas-model-override "clear">>

	<<if _args[0]>>
		<<if $wraith.possessCount is undefined>>
			<<set $wraith.possessCount to 1>>
		<<else>>
			<<set $wraith.possessCount++>>
		<</if>>
	<</if>>

	<<if _args[1] and $controlSaved isnot undefined>>
		<<set $control to $controlSaved>><<unset $controlSaved>>
	<</if>>
<</widget>>

<<widget "gobsession">>
	<<if !$wraith.init>>
		<span class="red">ERROR: Wraith is not initialised.</span>
		<br><br>
		Offending event: $passage | Location: $location ($bus)
	<<else>>
		<<set $_change to (_args[0] ? _args[0] : 1)>>
		<<set C.npc["Ivory Wraith"].lust += $_change>>
		<<if $statdisable is "f">> |
			<<switch $_change>>
				<<case 1 2>>
					<span class="red">+ Obsession</span>
				<<case 3 4>>
					<span class="red">+ + Obsession</span>
				<<case 5 6 7 8 9 10>>
					<span class="red">+ + + Obsession</span>
				<<default>>
			<</switch>>
		<</if>>
	<</if>>
	<<relationshipclamp>>
<</widget>>

<<widget "lobsession">>
	<<if !$wraith.init>>
		<span class="red">ERROR: Wraith is not initialised.</span>
		<br><br>
		Offending event: $passage | Location: $location ($bus)
	<<else>>
		<<set $_change to (_args[0] ? _args[0] : 1)>>
		<<set C.npc["Ivory Wraith"].lust -= $_change>>
		<<if $wraith.state is "haunt" and C.npc["Ivory Wraith"].lust lt 10>>
			<<set $_change -= (10 - C.npc["Ivory Wraith"].lust)>>
		<</if>>
		<<if $statdisable is "f">> |
			<<switch $_change>>
				<<case 1 2>>
					<span class="blue">- Obsession</span>
				<<case 3 4>>
					<span class="blue">- - Obsession</span>
				<<case 5 6 7 8 9 10>>
						<span class="blue">- - - Obsession</span>
				<<default>>
			<</switch>>
		<</if>>
	<</if>>
	<<relationshipclamp>>
<</widget>>
